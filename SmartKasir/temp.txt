import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import '../features/activation/presentation/providers/activation_providers.dart';
import '../features/auth/presentation/providers/auth_providers.dart';
import '../features/dashboard/presentation/pages/dashboard_page.dart';
import '../features/products/presentation/pages/products_placeholder_page.dart';
import '../features/reports/presentation/pages/reports_placeholder_page.dart';
import '../features/settings/presentation/pages/settings_page.dart';
import '../features/transactions/presentation/pages/transactions_placeholder_page.dart';

class MainNavigationShell extends ConsumerStatefulWidget {
  const MainNavigationShell({super.key});

  @override
  ConsumerState<MainNavigationShell> createState() => _MainNavigationShellState();
}

class _MainNavigationShellState extends ConsumerState<MainNavigationShell> {
  int _currentIndex = 0;

  static final List<_NavigationDestination> _allDestinations = [
    _NavigationDestination(
      icon: Icons.dashboard_outlined,
      activeIcon: Icons.dashboard,
      label: 'Dashboard',
      builder: () => const DashboardPage(),
      allowedRoles: const {'admin', 'cashier'},
    ),
    _NavigationDestination(
      icon: Icons.inventory_2_outlined,
      activeIcon: Icons.inventory_2,
      label: 'Produk',
      builder: () => const ProductsPlaceholderPage(),
      allowedRoles: const {'admin', 'cashier'},
    ),
    _NavigationDestination(
      icon: Icons.shopping_cart_outlined,
      activeIcon: Icons.shopping_cart,
      label: 'Transaksi',
      builder: () => const TransactionsPlaceholderPage(),
      allowedRoles: const {'admin', 'cashier'},
    ),
    _NavigationDestination(
      icon: Icons.bar_chart_outlined,
      activeIcon: Icons.bar_chart,
      label: 'Laporan',
      builder: () => const ReportsPlaceholderPage(),
      allowedRoles: const {'admin'},
      requiresPremium: true,
    ),
    _NavigationDestination(
      icon: Icons.settings_outlined,
      activeIcon: Icons.settings,
      label: 'Pengaturan',
      builder: () => const SettingsPage(),
      allowedRoles: const {'admin'},
      requiresPremium: true,
    ),
  ];

  @override
  Widget build(BuildContext context) {
    final authState = ref.watch(authNotifierProvider);
    final activationState = ref.watch(activationNotifierProvider);
    final role = authState.user?.role ?? 'cashier';
    final isPremiumActive = activationState.isPremium;
    final userName = authState.user?.displayName ?? 'Admin';
    final userEmail = '${authState.user?.username ?? 'admin'}@smartkasir.com';

    final availableDestinations = _allDestinations
        .where(
          (destination) => destination.allowedRoles.contains(role) &&
              (!destination.requiresPremium || isPremiumActive),
        )
        .toList();

    if (availableDestinations.isEmpty) {
      return const SizedBox.shrink();
    }

    if (_currentIndex >= availableDestinations.length) {
      _currentIndex = availableDestinations.length - 1;
    }

    final isWide = MediaQuery.sizeOf(context).width >= 1024;

    return Scaffold(
      backgroundColor: const Color(0xFFF6F7FB),
      body: Row(
        children: [
          if (isWide)
            _Sidebar(
              destinations: availableDestinations,
              currentIndex: _currentIndex,
              onSelect: (index) => setState(() => _currentIndex = index),
              userName: userName,
              userEmail: userEmail,
              onLogout: () => ref.read(authNotifierProvider.notifier).logout(),
            ),
          Expanded(
            child: AnimatedSwitcher(
              duration: const Duration(milliseconds: 200),
              child: availableDestinations[_currentIndex].builder(),
            ),
          ),
        ],
      ),
      bottomNavigationBar: isWide ? null : _buildBottomNavBar(availableDestinations),
    );
  }

  Widget _buildBottomNavBar(List<_NavigationDestination> destinations) {
    return NavigationBar(
      selectedIndex: _currentIndex,
      onDestinationSelected: (index) {
        setState(() => _currentIndex = index);
      },
      destinations: [
        for (final destination in destinations)
          NavigationDestination(
            icon: Icon(destination.icon),
            selectedIcon: Icon(destination.activeIcon),
            label: destination.label,
          ),
      ],
    );
  }
}

class _Sidebar extends StatelessWidget {
  const _Sidebar({
    required this.destinations,
    required this.currentIndex,
    required this.onSelect,
    required this.userName,
    required this.userEmail,
    required this.onLogout,
  });

  final List<_NavigationDestination> destinations;
  final int currentIndex;
  final ValueChanged<int> onSelect;
  final String userName;
  final String userEmail;
  final VoidCallback onLogout;

  @override
  Widget build(BuildContext context) {
    return Container(
      width: 260,
      decoration: const BoxDecoration(
        color: Color(0xFF0F1D3B),
      ),
      child: Column(
        children: [
          const SizedBox(height: 24),
          _buildHeader(),
          const SizedBox(height: 24),
          Expanded(
            child: ListView.separated(
              itemCount: destinations.length,
              separatorBuilder: (_, __) => const SizedBox(height: 6),
              itemBuilder: (_, index) {
                final item = destinations[index];
                final isActive = index == currentIndex;
                return _SidebarItem(
                  icon: item.icon,
                  label: item.label,
                  isActive: isActive,
                  onTap: () => onSelect(index),
                );
              },
            ),
          ),
          _buildUserCard(),
        ],
      ),
    );
  }

  Widget _buildHeader() {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 20),
      child: Row(
        children: [
          Container(
            height: 44,
            width: 44,
            decoration: const BoxDecoration(
              shape: BoxShape.circle,
              gradient: LinearGradient(
                colors: [Color(0xFF6A7BFF), Color(0xFF7F4FD7)],
              ),
            ),
            alignment: Alignment.center,
            child: const Text(
              'SK',
              style: TextStyle(
                color: Colors.white,
                fontWeight: FontWeight.bold,
              ),
            ),
          ),
          const SizedBox(width: 12),
          const Text(
            'SmartKasir',
            style: TextStyle(
              color: Colors.white,
              fontWeight: FontWeight.bold,
              fontSize: 16,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildUserCard() {
    return Container(
      width: double.infinity,
      padding: const EdgeInsets.all(16),
      decoration: const BoxDecoration(
        color: Color(0xFF111F3D),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.stretch,
        children: [
          Row(
            children: [
              CircleAvatar(
                backgroundColor: const Color(0xFF7F4FD7),
                child: Text(
                  userName.isNotEmpty ? userName[0].toUpperCase() : 'A',
                  style: const TextStyle(color: Colors.white),
                ),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      userName,
                      style: const TextStyle(
                        color: Colors.white,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    Text(
                      userEmail,
                      style: const TextStyle(
                        color: Color(0xFFC5C8D5),
                        fontSize: 12,
                      ),
                      overflow: TextOverflow.ellipsis,
                    ),
                  ],
                ),
              ),
            ],
          ),
          const SizedBox(height: 16),
          OutlinedButton.icon(
            onPressed: onLogout,
            style: OutlinedButton.styleFrom(
              foregroundColor: Colors.red,
              side: const BorderSide(color: Colors.red),
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(12),
              ),
            ),
            icon: const Icon(Icons.logout, size: 18),
            label: const Text('Logout'),
          ),
        ],
      ),
    );
  }
}

class _SidebarItem extends StatelessWidget {
  const _SidebarItem({
    required this.icon,
    required this.label,
    required this.isActive,
    required this.onTap,
  });

  final IconData icon;
  final String label;
  final bool isActive;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 12),
      child: Material(
        color: isActive ? const Color(0xFF2E2F55) : Colors.transparent,
        borderRadius: BorderRadius.circular(12),
        child: InkWell(
          borderRadius: BorderRadius.circular(12),
          onTap: onTap,
          child: Padding(
            padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 14),
            child: Row(
              children: [
                Icon(
                  icon,
                  color: isActive ? Colors.white : const Color(0xFFC5C8D5),
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: Text(
                    label,
                    style: TextStyle(
                      color: isActive ? Colors.white : const Color(0xFFC5C8D5),
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

class _NavigationDestination {
  const _NavigationDestination({
    required this.icon,
    required this.activeIcon,
    required this.label,
    required this.builder,
    required this.allowedRoles,
    this.requiresPremium = false,
  });

  final IconData icon;
  final IconData activeIcon;
  final String label;
  final Widget Function() builder;
  final Set<String> allowedRoles;
  final bool requiresPremium;
}

